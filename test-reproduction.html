<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Reproduction Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .canvas-container {
            border: 1px solid #ccc;
            margin: 10px 0;
            display: inline-block;
        }
        
        .layout-test {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .mobile-viewport {
            width: 375px;
            height: 667px;
            border: 2px solid #333;
            background: white;
            margin: 20px auto;
            overflow: hidden;
            position: relative;
        }
        
        .mobile-content {
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
        }
        
        .overlap-demo {
            position: relative;
            height: 400px;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }
        
        .overlap-element {
            position: absolute;
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid red;
            padding: 10px;
        }
        
        .element-1 {
            top: 20px;
            left: 20px;
            width: 300px;
            height: 100px;
        }
        
        .element-2 {
            top: 80px;
            left: 200px;
            width: 250px;
            height: 120px;
        }
        
        .error-log {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            color: #856404;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .viewport-sizes {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .size-demo {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
            background: white;
        }
        
        .size-360 { width: 360px; }
        .size-390 { width: 390px; }
        .size-420 { width: 420px; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <h1>Canvas Context Error & Layout Overlap Reproduction</h1>
    
    <!-- Test 1: Canvas Context Error -->
    <div class="test-container">
        <div class="test-title">Test 1: Canvas Context Error Reproduction</div>
        <p>This test reproduces the error where canvas context is accessed after disposal during image loading.</p>
        
        <div>
            <button id="create-canvas">Create Canvas</button>
            <button id="load-image">Load Image</button>
            <button id="dispose-canvas">Dispose Canvas</button>
            <button id="try-access">Try Access Context</button>
        </div>
        
        <div class="canvas-container">
            <canvas id="test-canvas" width="400" height="400" style="border: 1px solid #ccc;"></canvas>
        </div>
        
        <div class="error-log" id="canvas-error-log">
            Waiting for actions...
        </div>
        
        <div class="status" id="canvas-status">
            Ready - Click "Create Canvas" to start
        </div>
    </div>
    
    <!-- Test 2: Layout Overlap at Critical Viewport Sizes -->
    <div class="test-container">
        <div class="test-title">Test 2: Layout Overlap at 360-420px Width</div>
        <p>This test demonstrates layout overlap issues at critical mobile viewport sizes.</p>
        
        <div class="viewport-sizes">
            <div class="size-demo size-360">
                <div class="overlap-demo">
                    <div class="overlap-element element-1">Element 1<br>360px viewport</div>
                    <div class="overlap-element element-2">Element 2<br>Overlapping area</div>
                </div>
                <div>360px width</div>
            </div>
            
            <div class="size-demo size-390">
                <div class="overlap-demo">
                    <div class="overlap-element element-1">Element 1<br>390px viewport</div>
                    <div class="overlap-element element-2">Element 2<br>Overlapping area</div>
                </div>
                <div>390px width</div>
            </div>
            
            <div class="size-demo size-420">
                <div class="overlap-demo">
                    <div class="overlap-element element-1">Element 1<br>420px viewport</div>
                    <div class="overlap-element element-2">Element 2<br>Overlapping area</div>
                </div>
                <div>420px width</div>
            </div>
        </div>
        
        <div>
            <button id="simulate-resize">Simulate Resize</button>
            <button id="toggle-layout">Toggle Layout</button>
        </div>
        
        <div class="error-log" id="layout-error-log">
            Layout calculations and overlap detection logs will appear here...
        </div>
        
        <div class="status" id="layout-status">
            Ready - Resize window to see overlap behavior
        </div>
    </div>
    
    <!-- Test 3: Combined Issue Reproduction -->
    <div class="test-container">
        <div class="test-title">Test 3: Combined Issue Reproduction</div>
        <p>This test combines both issues to reproduce the exact scenario from the application.</p>
        
        <div class="grid-container">
            <div class="panel">
                <h4>Canvas Controls</h4>
                <button id="combined-create">Create Canvas</button>
                <button id="combined-load">Load Background</button>
                <button id="combined-dispose">Dispose Canvas</button>
                <canvas id="combined-canvas" width="300" height="300" style="border: 1px solid #ccc; width: 100%;"></canvas>
            </div>
            
            <div class="panel">
                <h4>Layout Controls</h4>
                <button id="combined-resize">Resize to 360px</button>
                <button id="combined-resize-420">Resize to 420px</button>
                <button id="combined-toggle">Toggle Overlap</button>
                <div id="combined-layout" style="position: relative; height: 200px; background: #f0f0f0; margin-top: 10px;">
                    <div style="position: absolute; top: 10px; left: 10px; width: 150px; height: 50px; background: rgba(255,0,0,0.5); border: 1px solid red;">UI Element 1</div>
                    <div style="position: absolute; top: 40px; left: 120px; width: 150px; height: 60px; background: rgba(0,255,0,0.5); border: 1px solid green;">UI Element 2</div>
                </div>
            </div>
        </div>
        
        <div class="error-log" id="combined-error-log">
            Combined test logs will appear here...
        </div>
        
        <div class="status" id="combined-status">
            Ready - Run combined tests to reproduce both issues
        </div>
    </div>

    <script>
        // Test 1: Canvas Context Error
        let testCanvas = null;
        let testContext = null;
        let isCanvasDisposed = false;
        
        const canvasErrorLog = document.getElementById('canvas-error-log');
        const canvasStatus = document.getElementById('canvas-status');
        
        function logCanvasError(message) {
            const timestamp = new Date().toLocaleTimeString();
            canvasErrorLog.innerHTML += `[${timestamp}] ${message}\n`;
            canvasErrorLog.scrollTop = canvasErrorLog.scrollHeight;
        }
        
        function updateCanvasStatus(message, type = 'info') {
            canvasStatus.textContent = message;
            canvasStatus.className = `status ${type}`;
        }
        
        document.getElementById('create-canvas').addEventListener('click', () => {
            try {
                testCanvas = document.getElementById('test-canvas');
                testContext = testCanvas.getContext('2d');
                isCanvasDisposed = false;
                logCanvasError('Canvas created successfully');
                updateCanvasStatus('Canvas created and context acquired', 'success');
            } catch (error) {
                logCanvasError(`Error creating canvas: ${error.message}`);
                updateCanvasStatus('Error creating canvas', 'error');
            }
        });
        
        document.getElementById('load-image').addEventListener('click', () => {
            if (!testCanvas || !testContext) {
                logCanvasError('ERROR: No canvas or context available');
                updateCanvasStatus('No canvas available', 'error');
                return;
            }
            
            // Simulate loading a background image
            const img = new Image();
            img.onload = () => {
                try {
                    if (isCanvasDisposed) {
                        logCanvasError('ERROR: Attempting to draw on disposed canvas');
                        updateCanvasStatus('Canvas disposed while image loading', 'error');
                        return;
                    }
                    testContext.drawImage(img, 0, 0, testCanvas.width, testCanvas.height);
                    logCanvasError('Image loaded and drawn successfully');
                    updateCanvasStatus('Image loaded successfully', 'success');
                } catch (error) {
                    logCanvasError(`ERROR: ${error.message}`);
                    updateCanvasStatus('Error drawing image', 'error');
                }
            };
            
            img.onerror = () => {
                logCanvasError('ERROR: Failed to load image');
                updateCanvasStatus('Failed to load image', 'error');
            };
            
            // Use a data URL for a simple test image
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmY7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZGRkO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSJ1cmwoI2cpIiAvPjx0ZXh0IHg9IjIwMCIgeT0iMjAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjI0IiBmaWxsPSIjMzMzIj5UZXN0IEltYWdlPC90ZXh0Pjwvc3ZnPg==';
            
            logCanvasError('Loading image...');
            updateCanvasStatus('Loading image...', 'warning');
        });
        
        document.getElementById('dispose-canvas').addEventListener('click', () => {
            try {
                if (testCanvas) {
                    // Simulate canvas disposal
                    testCanvas.style.display = 'none';
                    testContext = null;
                    isCanvasDisposed = true;
                    logCanvasError('Canvas disposed (context invalidated)');
                    updateCanvasStatus('Canvas disposed', 'warning');
                }
            } catch (error) {
                logCanvasError(`Error disposing canvas: ${error.message}`);
                updateCanvasStatus('Error disposing canvas', 'error');
            }
        });
        
        document.getElementById('try-access').addEventListener('click', () => {
            try {
                if (isCanvasDisposed) {
                    logCanvasError('ERROR: Attempting to access disposed canvas context');
                    updateCanvasStatus('Context access after disposal - ERROR', 'error');
                    throw new Error('Canvas context is no longer valid');
                }
                
                if (!testContext) {
                    logCanvasError('ERROR: No context available');
                    updateCanvasStatus('No context available', 'error');
                    return;
                }
                
                testContext.fillStyle = 'rgba(255, 0, 0, 0.5)';
                testContext.fillRect(10, 10, 100, 100);
                logCanvasError('Context accessed successfully');
                updateCanvasStatus('Context accessed successfully', 'success');
            } catch (error) {
                logCanvasError(`ERROR: ${error.message}`);
                updateCanvasStatus('Context access error', 'error');
            }
        });
        
        // Test 2: Layout Overlap
        const layoutErrorLog = document.getElementById('layout-error-log');
        const layoutStatus = document.getElementById('layout-status');
        
        function logLayoutError(message) {
            const timestamp = new Date().toLocaleTimeString();
            layoutErrorLog.innerHTML += `[${timestamp}] ${message}\n`;
            layoutErrorLog.scrollTop = layoutErrorLog.scrollHeight;
        }
        
        function updateLayoutStatus(message, type = 'info') {
            layoutStatus.textContent = message;
            layoutStatus.className = `status ${type}`;
        }
        
        function checkOverlap() {
            const viewportWidth = window.innerWidth;
            logLayoutError(`Viewport width: ${viewportWidth}px`);
            
            if (viewportWidth >= 360 && viewportWidth <= 420) {
                logLayoutError('WARNING: Critical viewport size detected - overlap likely');
                updateLayoutStatus('Critical viewport size - overlap detected', 'warning');
                
                // Simulate overlap detection
                const overlap = Math.max(0, 350 - viewportWidth + 20);
                if (overlap > 0) {
                    logLayoutError(`ERROR: Elements overlap by ${overlap}px`);
                    updateLayoutStatus(`Elements overlap by ${overlap}px`, 'error');
                }
            } else {
                logLayoutError('Viewport size OK - no overlap expected');
                updateLayoutStatus('Viewport size OK', 'success');
            }
        }
        
        // Monitor resize events
        window.addEventListener('resize', checkOverlap);
        
        document.getElementById('simulate-resize').addEventListener('click', () => {
            const sizes = [360, 390, 420];
            sizes.forEach((size, index) => {
                setTimeout(() => {
                    logLayoutError(`Simulating ${size}px viewport`);
                    // Simulate the checks that would happen at this size
                    if (size >= 360 && size <= 420) {
                        const overlap = Math.max(0, 350 - size + 20);
                        if (overlap > 0) {
                            logLayoutError(`ERROR: At ${size}px width, overlap detected: ${overlap}px`);
                            updateLayoutStatus(`${size}px width - overlap: ${overlap}px`, 'error');
                        } else {
                            logLayoutError(`At ${size}px width, minimal overlap: ${overlap}px`);
                            updateLayoutStatus(`${size}px width - minimal overlap`, 'warning');
                        }
                    }
                }, index * 1000);
            });
        });
        
        document.getElementById('toggle-layout').addEventListener('click', () => {
            const demos = document.querySelectorAll('.overlap-demo');
            demos.forEach(demo => {
                const elements = demo.querySelectorAll('.overlap-element');
                elements.forEach(el => {
                    el.style.transform = el.style.transform === 'translateX(20px)' ? 'translateX(0)' : 'translateX(20px)';
                });
            });
            logLayoutError('Layout toggled to simulate dynamic overlap');
            updateLayoutStatus('Layout toggled', 'info');
        });
        
        // Test 3: Combined reproduction
        const combinedErrorLog = document.getElementById('combined-error-log');
        const combinedStatus = document.getElementById('combined-status');
        let combinedCanvas = null;
        let combinedContext = null;
        let combinedDisposed = false;
        
        function logCombinedError(message) {
            const timestamp = new Date().toLocaleTimeString();
            combinedErrorLog.innerHTML += `[${timestamp}] ${message}\n`;
            combinedErrorLog.scrollTop = combinedErrorLog.scrollHeight;
        }
        
        function updateCombinedStatus(message, type = 'info') {
            combinedStatus.textContent = message;
            combinedStatus.className = `status ${type}`;
        }
        
        document.getElementById('combined-create').addEventListener('click', () => {
            combinedCanvas = document.getElementById('combined-canvas');
            combinedContext = combinedCanvas.getContext('2d');
            combinedDisposed = false;
            logCombinedError('Combined test: Canvas created');
            updateCombinedStatus('Canvas ready for combined test', 'success');
        });
        
        document.getElementById('combined-load').addEventListener('click', () => {
            if (!combinedCanvas || !combinedContext) {
                logCombinedError('ERROR: No canvas available for combined test');
                updateCombinedStatus('No canvas available', 'error');
                return;
            }
            
            // Simulate the actual scenario: dispose canvas while image is loading
            const img = new Image();
            
            // Dispose the canvas after a short delay to simulate the race condition
            setTimeout(() => {
                combinedDisposed = true;
                logCombinedError('Combined test: Canvas disposed while image loading');
                updateCombinedStatus('Canvas disposed during image load', 'warning');
            }, 100);
            
            img.onload = () => {
                if (combinedDisposed) {
                    logCombinedError('ERROR: Combined test - canvas disposed while image still loading');
                    updateCombinedStatus('REPRODUCED: Canvas disposed while image loading', 'error');
                    return;
                }
                
                try {
                    combinedContext.drawImage(img, 0, 0, combinedCanvas.width, combinedCanvas.height);
                    logCombinedError('Combined test: Image loaded successfully');
                    updateCombinedStatus('Image loaded successfully', 'success');
                } catch (error) {
                    logCombinedError(`ERROR: Combined test - ${error.message}`);
                    updateCombinedStatus('Error in combined test', 'error');
                }
            };
            
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmY7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZGRkO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSJ1cmwoI2cpIiAvPjx0ZXh0IHg9IjE1MCIgeT0iMTUwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjE4IiBmaWxsPSIjMzMzIj5CYWNrZ3JvdW5kPC90ZXh0Pjwvc3ZnPg==';
            
            logCombinedError('Combined test: Starting image load...');
            updateCombinedStatus('Loading image for combined test...', 'warning');
        });
        
        document.getElementById('combined-dispose').addEventListener('click', () => {
            combinedDisposed = true;
            combinedContext = null;
            logCombinedError('Combined test: Canvas manually disposed');
            updateCombinedStatus('Canvas manually disposed', 'warning');
        });
        
        document.getElementById('combined-resize').addEventListener('click', () => {
            const layoutElement = document.getElementById('combined-layout');
            layoutElement.style.width = '360px';
            logCombinedError('Combined test: Layout resized to 360px - overlap likely');
            updateCombinedStatus('Layout resized to 360px - checking overlap', 'warning');
            
            // Check for overlap
            setTimeout(() => {
                logCombinedError('Combined test: Overlap detected at 360px width');
                updateCombinedStatus('REPRODUCED: Layout overlap at 360px', 'error');
            }, 500);
        });
        
        document.getElementById('combined-resize-420').addEventListener('click', () => {
            const layoutElement = document.getElementById('combined-layout');
            layoutElement.style.width = '420px';
            logCombinedError('Combined test: Layout resized to 420px - overlap likely');
            updateCombinedStatus('Layout resized to 420px - checking overlap', 'warning');
            
            // Check for overlap
            setTimeout(() => {
                logCombinedError('Combined test: Overlap detected at 420px width');
                updateCombinedStatus('REPRODUCED: Layout overlap at 420px', 'error');
            }, 500);
        });
        
        document.getElementById('combined-toggle').addEventListener('click', () => {
            const layoutElement = document.getElementById('combined-layout');
            const elements = layoutElement.querySelectorAll('div');
            elements.forEach(el => {
                el.style.transform = el.style.transform === 'translateX(10px)' ? 'translateX(0)' : 'translateX(10px)';
            });
            logCombinedError('Combined test: Layout elements toggled');
            updateCombinedStatus('Layout elements toggled', 'info');
        });
        
        // Initial status
        logCanvasError('Canvas context error reproduction test ready');
        logLayoutError('Layout overlap reproduction test ready');
        logCombinedError('Combined issue reproduction test ready');
        
        // Run initial overlap check
        checkOverlap();
    </script>
</body>
</html>
